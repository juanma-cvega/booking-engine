#!/bin/sh
#
# Git pre-commit hook to:
# 1. Enforce code formatting with Spotless
# 2. Auto-update context.md with commit changes
#

echo "Running Spotless format check..."

# Set JAVA_HOME to Java 25 (with fallback to Java 21)
export JAVA_HOME=$(/usr/libexec/java_home -v 25 2>/dev/null || /usr/libexec/java_home -v 21)

# Run spotless check
mvn spotless:check -q

# Capture exit code
SPOTLESS_EXIT_CODE=$?

if [ $SPOTLESS_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "❌ Code formatting check failed!"
    echo ""
    echo "Your code is not properly formatted according to Google Java Format."
    echo ""
    echo "To fix formatting issues, run:"
    echo "  mvn spotless:apply"
    echo ""
    echo "Then stage your changes and commit again."
    echo ""
    exit 1
fi

echo "✅ Code formatting check passed!"

echo "Running tests..."

# Run tests
mvn test -q

# Capture exit code
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "❌ Tests failed!"
    echo ""
    echo "Please fix the failing tests before committing."
    echo ""
    echo "To see detailed test output, run:"
    echo "  mvn test"
    echo ""
    exit 1
fi

echo "✅ All tests passed!"

# Note: context.md is updated by the post-commit hook with actual commit information

exit 0
